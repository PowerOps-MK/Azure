{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "vnetName": {
      "type": "string",
      "defaultValue": "[format('vnet{0}', uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "Specifies the name of the Azure Storage account."
      }
    },
    "ngName": {
      "type": "string",
      "defaultValue": "[format('Natgateway{0}', uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "Specifies the name of the Azure Storage account."
      }
    },		
    "ipNGName": {
      "type": "string",
      "defaultValue": "[format('IPNG{0}', uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "Specifies the name of the Azure Storage account."
      }
    },	
    "vnetGWName": {
      "type": "string",
      "defaultValue": "[format('vnetGW{0}', uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "Specifies the name of the Azure Storage account."
      }
    },
    "gwName": {
      "type": "string",
      "defaultValue": "[format('gateway{0}', uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "Specifies the name of the Azure Storage account."
      }
    },	
    "ipGWName": {
      "type": "string",
      "defaultValue": "[format('IPGW{0}', uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "Specifies the name of the Azure Storage account."
      }
    },	
    "vnetBastionName": {
      "type": "string",
      "defaultValue": "[format('vnetBastion{0}', uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "Specifies the name of the Azure Storage account."
      }
    },	
    "ipBastionName": {
      "type": "string",
      "defaultValue": "[format('IPBastion{0}', uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "Specifies the name of the Azure Storage account."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Specifies the location in which the Azure Storage resources should be deployed."
      }
    }
  },
  "variables": {},
  "resources": [
    {
      "type": "Microsoft.Network/virtualNetworks",
	  "apiVersion": "2023-04-01",
      "name": "[parameters('vnetName')]",
      "location": "[parameters('location')]",
      "properties": {
	    "addressSpace": {
		  "addressPrefixes": [
		    "10.10.0.0/16"
		  ]
	    }
	  }
    },
    {
      "type": "Microsoft.Network/virtualNetworks/subnets",
      "apiVersion": "2023-04-01",
      "name": "[concat(parameters('vnetName'), '/subnetA')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/virtualNetworks/', parameters('vnetName'))]"
      ],
      "properties": {
        "addressPrefix": "10.10.0.0/24"
      }
    },	
    {
      "type": "Microsoft.Network/publicIPAddresses",
      "apiVersion": "2023-04-01",
      "name": "[parameters('ipNGNameName')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/virtualNetworks/', parameters('vnetName'))]"
      ],	  
	  "sku": {
        "name": "Standard",
		"tier": "Regional"
	  },
	  "zones": [],
      "properties": {
		"publicIPAddressVersion": "IPv4",
		"publicIPAllocationMethod": "Static"
	  }
    },	
    {
      "type": "Microsoft.Network/virtualNetworks",
	  "apiVersion": "2023-04-01",
      "name": "[parameters('vnetGWName')]",
      "location": "[parameters('location')]",
      "properties": {
	    "addressSpace": {
		  "addressPrefixes": [
		    "10.20.0.0/16"
		  ]
	    }
	  }
    },
    {
      "type": "Microsoft.Network/virtualNetworks/subnets",
      "apiVersion": "2023-04-01",
      "name": "[concat(parameters('vnetGWName'), '/GatewaySubnet')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/virtualNetworks/', parameters('vnetGWName'))]"
      ],
      "properties": {
        "addressPrefix": "10.20.0.0/24"
      }
    },	
    {
      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
      "apiVersion": "2023-04-01",
      "name": "[concat(parameters('vnetName'), '/Vnet-To-GW')]",
      "location": "[parameters('location')]",
	  "dependsOn": [
        "[resourceId('Microsoft.Network/virtualNetworks/', parameters('vnetName'))]"
	  ],	  
      "properties": {
  	    "allowVirtualNetworkAccess": "true",
 	    "allowForwardedTraffic": "true",
	    "allowGatewayTransit": "false",
	    "useRemoteGateways": "false",
	    "remoteVirtualNetwork": {
          "id": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetGWName'))]"
	    }
      }
    },
    {
      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
      "apiVersion": "2023-04-01",
      "name": "[concat(parameters('vnetGWName'), '/GW-To-Vnet')]",
      "location": "[parameters('location')]",
	  "dependsOn": [
        "[resourceId('Microsoft.Network/virtualNetworks/', parameters('vnetGWName'))]"
	  ],	  
      "properties": {
  	    "allowVirtualNetworkAccess": "true",
 	    "allowForwardedTraffic": "true",
	    "allowGatewayTransit": "true",
	    "useRemoteGateways": "false",
	    "remoteVirtualNetwork": {
          "id": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
	    }
      }
    },
    {
      "type": "Microsoft.Network/publicIPAddresses",
      "apiVersion": "2023-04-01",
      "name": "[parameters('ipGWName')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/virtualNetworks/', parameters('vnetGWName'))]"
      ],	  
	  "sku": {
        "name": "Standard",
		"tier": "Regional"
	  },
	  "zones": [],
      "properties": {
		"publicIPAddressVersion": "IPv4",
		"publicIPAllocationMethod": "Static"
	  }
    },
	{
	  "type": "Microsoft.Network/virtualNetworkGateways",
	  "apiVersion": "2023-02-01",
	  "name": "[parameters('gwName')]",
	  "location": "[parameters('location')]",
	  "dependsOn": [
		"[resourceId('Microsoft.Network/virtualNetworks/', parameters('vnetGWName'))]"
	  ],
	  "properties": {
		"vpnType": "RouteBased",
		"vpnGatewayGeneration": "Generation1",
		"sku": {
		  "name": "VpnGw1",
		  "tier": "VpnGw1"
		},		  
		"gatewayType": "Vpn",
		"ipConfigurations": [
		  {
			"name": "default",
			"properties": {
			  "privateIPAllocationMethod": "Dynamic",
			  "subnet": {
				"id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetGWName'), 'subnetGW')]"
			  },
			  "publicIpAddress": {
				"id": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('ipGWName'))]"
			  }
			}
		  }
		]
	  }
	},
    {
      "type": "Microsoft.Network/virtualNetworks",
	  "apiVersion": "2023-04-01",
      "name": "[parameters('vnetBastionName')]",
      "location": "[parameters('location')]",
      "properties": {
	    "addressSpace": {
		  "addressPrefixes": [
		    "10.40.0.0/16"
		  ]
	    }
	  }
    },
    {
      "type": "Microsoft.Network/virtualNetworks/subnets",
      "apiVersion": "2023-04-01",
      "name": "[concat(parameters('vnetBastionName'), '/AzureBastionSubnet')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/virtualNetworks/', parameters('vnetBastionName'))]"
      ],
      "properties": {
        "addressPrefix": "10.40.0.0/24"
      }
    },	
    {
      "type": "Microsoft.Network/publicIPAddresses",
      "apiVersion": "2023-04-01",
      "name": "[parameters('ipBastionName')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/virtualNetworks/', parameters('vnetBastionName'))]"
      ],	  
	  "sku": {
        "name": "Standard",
		"tier": "Regional"
	  },
	  "zones": [],
      "properties": {
		"publicIPAddressVersion": "IPv4",
		"publicIPAllocationMethod": "Static"
	  }
    }
  ],
  "outputs": {}
}
